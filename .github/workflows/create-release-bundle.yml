name: Create Release Bundle

on:
  workflow_dispatch:

jobs:
  create-release-bundle:
    name: Create Release Bundle
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4
      with:
        version: latest
      env:
        JF_URL: ${{ vars.JF_URL }}
        JF_USER: ${{ vars.JF_USER }}
        JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
    
    - name: Get latest quoteofday build number
      id: get-latest-builds
      run: |
        # Fetch build information from Artifactory API
        BUILD_RESPONSE=$(curl -s -X GET \
          -H "Authorization: Bearer ${{ secrets.JF_ACCESS_TOKEN }}" \
          "${{ vars.JF_URL }}/artifactory/api/build/quoteofday")
        LATEST_QUOTEOFDAY_BUILD_NUMBER=$(echo "$BUILD_RESPONSE" | \
          jq -r '.buildsNumbers | sort_by(.started) | reverse | .[0].uri | ltrimstr("/")')
        
        echo "latest_quoteofday_build_number=$LATEST_QUOTEOFDAY_BUILD_NUMBER" >> $GITHUB_OUTPUT
        echo "Found latest quoteofday build number: $LATEST_QUOTEOFDAY_BUILD_NUMBER"

        BUILD_RESPONSE=$(curl -s -X GET \
          -H "Authorization: Bearer ${{ secrets.JF_ACCESS_TOKEN }}" \
          "${{ vars.JF_URL }}/artifactory/api/build/ai-translate")
        LATEST_AI_TRANSLATE_BUILD_NUMBER=$(echo "$BUILD_RESPONSE" | \
          jq -r '.buildsNumbers | sort_by(.started) | reverse | .[0].uri | ltrimstr("/")')
        
        echo "latest_ai_translate_build_number=$LATEST_AI_TRANSLATE_BUILD_NUMBER" >> $GITHUB_OUTPUT
        echo "Found latest ai-translate build number: $LATEST_AI_TRANSLATE_BUILD_NUMBER"
    
    # - name: Find latest quoteofday package version
    #   id: find-quoteofday-version
    #   run: |
    #     QUOTEOFDAY_PATH=$(curl -s -X POST \
    #       -H "Content-Type: text/plain" \
    #       -H "Authorization: Bearer ${{ secrets.JF_ACCESS_TOKEN }}" \
    #       -d 'items.find({"repo": "commons-dev-docker-local", "name": "list.manifest.json", "path": {"$match": "quoteofday/*"}}).sort({"$desc":["created"]}).limit(1)' \
    #       "${{ vars.JF_URL }}/artifactory/api/search/aql" | \
    #       jq -r '.results[0].path // empty')
        
    #     if [ -z "$QUOTEOFDAY_PATH" ]; then
    #       echo "Error: Could not find latest quoteofday package version"
    #       exit 1
    #     fi
        
    #     echo "quoteofday_path=$QUOTEOFDAY_PATH" >> $GITHUB_OUTPUT
    #     echo "Found quoteofday path: $QUOTEOFDAY_PATH"
    
    # - name: Find latest ai-translate package version
    #   id: find-ai-translate-version
    #   run: |
    #     AI_TRANSLATE_PATH=$(curl -s -X POST \
    #       -H "Content-Type: text/plain" \
    #       -H "Authorization: Bearer ${{ secrets.JF_ACCESS_TOKEN }}" \
    #       -d 'items.find({"repo": "commons-dev-docker-local", "name": "list.manifest.json", "path": {"$match": "ai-translate/*"}}).sort({"$desc":["created"]}).limit(1)' \
    #       "${{ vars.JF_URL }}/artifactory/api/search/aql" | \
    #       jq -r '.results[0].path // empty')
        
    #     if [ -z "$AI_TRANSLATE_PATH" ]; then
    #       echo "Error: Could not find latest ai-translate package version"
    #       exit 1
    #     fi
        
    #     echo "ai-translate_path=$AI_TRANSLATE_PATH" >> $GITHUB_OUTPUT
    #     echo "Found ai-translate path: $AI_TRANSLATE_PATH"
    

    
    - name: Create release bundle spec file
      id: create-spec
      run: |
        # Get build numbers from previous step
        QUOTEOFDAY_BUILD_NUMBER="${{ steps.get-latest-builds.outputs.latest_quoteofday_build_number }}"
        AI_TRANSLATE_BUILD_NUMBER="${{ steps.get-latest-builds.outputs.latest_ai_translate_build_number }}" 
        
        # Create the spec.json file
        cat > spec.json << EOF
        {
            "files": [
                {
                    "build": "quoteofday/$QUOTEOFDAY_BUILD_NUMBER"
                },
                {
                    "build": "ai-translate/$AI_TRANSLATE_BUILD_NUMBER"
                }
            ]
        }
        EOF
        
        echo "Created spec.json with versions:"
        echo "  quoteofday: $QUOTEOFDAY_BUILD_NUMBER"
        echo "  ai-translate: $AI_TRANSLATE_BUILD_NUMBER"
        cat spec.json
    
    - name: Create release bundle
      run: |
        jf release-bundle-create quotopia ${{ github.run_number }} --spec spec.json
        VER_LINK=${{ vars.JF_URL }}'/ui/artifactory/lifecycle?bundleName=quotopia&releaseBundleVersion=${{ github.run_number }}&repositoryKey=release-bundles-v2&activeVersionTab=Evidence%20Graph'
        echo 'ðŸ“¦ Release bundle [quotopia:${{ github.run_number }}]('${VER_LINK}') created' >> $GITHUB_STEP_SUMMARY

        VER_LINK=${{ vars.JF_URL }}'/ui/artifactory/lifecycle?bundleName=quotopia&releaseBundleVersion=${{ github.run_number }}&repositoryKey=release-bundles-v2&activeKanbanTab=promotion'
        jf release-bundle-promote quotopia ${{ github.run_number }} DEV
        echo 'ðŸš€ Release bundle [quotopia:${{ github.run_number }}]('${VER_LINK}') promoted to DEV' >> $GITHUB_STEP_SUMMARY
