name: Quote of Day Release Bundle

on:
  release:
    types: [published, created]
  workflow_dispatch:
    inputs:
      build_number:
        description: 'Build number to create release bundle from (optional)'
        required: false
        type: string

env:
  DOCKER_REGISTRY: ${{ vars.DOCKER_REGISTRY }}

jobs:
  create-release-bundle:
    name: Create Release Bundle
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4
      with:
        version: latest
      env:
        JF_URL: ${{ vars.JF_URL }}
        JF_USER: ${{ vars.JF_USER }}
        JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
    
    - name: Get latest build number
      id: get-build-number
      run: |
        if [ -n "${{ github.event.inputs.build_number }}" ]; then
          echo "build_number=${{ github.event.inputs.build_number }}" >> $GITHUB_OUTPUT
        else
          # Get the latest build number for the quoteofday build
          LATEST_BUILD=$(jf rt build-info quoteofday --limit=1 --format=json | jq -r '.[0].buildNumber')
          echo "build_number=$LATEST_BUILD" >> $GITHUB_OUTPUT
          echo "üì¶ Using latest build number: $LATEST_BUILD"
        fi
    
    - name: Create release bundle
      run: |
        BUILD_NUMBER=${{ steps.get-build-number.outputs.build_number }}
        RELEASE_VERSION="${{ github.event.release.tag_name || 'v1.0.0' }}"
        
        echo "üéØ Creating release bundle for build: quoteofday/$BUILD_NUMBER"
        echo "üì¶ Release version: $RELEASE_VERSION"
        
        # Create release bundle from the specified build
        jf release-bundle-create quoteofday $RELEASE_VERSION \
          --build-name=quoteofday \
          --build-number=$BUILD_NUMBER \
          --desc="Release bundle for Quote of Day service - $RELEASE_VERSION" \
          --release-notes="Release bundle created from build $BUILD_NUMBER for version $RELEASE_VERSION"
        
        echo "‚úÖ Release bundle created successfully"
    
    - name: Sign release bundle
      run: |
        RELEASE_VERSION="${{ github.event.release.tag_name || 'v1.0.0' }}"
        
        echo "üîê Signing release bundle: quoteofday/$RELEASE_VERSION"
        
        # Sign the release bundle
        jf release-bundle-sign quoteofday $RELEASE_VERSION \
          --desc="Signed release bundle for Quote of Day service - $RELEASE_VERSION"
        
        echo "‚úÖ Release bundle signed successfully"
    
    - name: Distribute release bundle
      run: |
        RELEASE_VERSION="${{ github.event.release.tag_name || 'v1.0.0' }}"
        
        echo "üì§ Distributing release bundle: quoteofday/$RELEASE_VERSION"
        
        # Distribute the release bundle (you may need to adjust the target repository)
        jf release-bundle-distribute quoteofday $RELEASE_VERSION \
          --target-repo="commons-dev-release-local" \
          --desc="Distributed release bundle for Quote of Day service - $RELEASE_VERSION"
        
        echo "‚úÖ Release bundle distributed successfully"
    
    - name: Display release bundle info
      run: |
        RELEASE_VERSION="${{ github.event.release.tag_name || 'v1.0.0' }}"
        
        echo "üìã Release Bundle Information:"
        echo "Name: quoteofday"
        echo "Version: $RELEASE_VERSION"
        echo "Build: quoteofday/${{ steps.get-build-number.outputs.build_number }}"
        echo "Created by: ${{ github.actor }}"
        echo "Created at: $(date -u)"
        
        # Get release bundle details
        jf release-bundle-info quoteofday $RELEASE_VERSION
