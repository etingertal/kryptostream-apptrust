name: Promote Application

on:
  workflow_dispatch:
    inputs:
      target_stage:
        description: 'Target promotion stage (e.g., DEV, QA, Staging, PROD)'
        required: true
        default: 'DEV'

jobs:
  promote-application:
    name: Promote Latest Application Version
    runs-on: ubuntu-latest
    env:
      JF_URL: ${{ vars.JF_URL }}
      JF_USER: ${{ vars.JF_USER }}
      JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
      APP_ID: quotopia-app
      TARGET_STAGE: ${{ github.event.inputs.target_stage }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get latest application version
        id: get_app_ver
        run: |
          # Use the API to get the latest version.
          # We use limit=1 and order_by=created to get the most recent version.
          API_URL="$JF_URL/apptrust/api/v1/applications/$APP_ID/versions?order_by=created&limit=1"
          
          echo "Fetching latest application version from: $API_URL"
          
          RESPONSE=$(curl -s -X GET \
            -H "Authorization: Bearer $JF_ACCESS_TOKEN" \
            "$API_URL")
          
          # Use jq to parse the JSON and extract the version.
          # The API returns an array 'versions', so we get the first element.
          LATEST_VER=$(echo "$RESPONSE" | jq -r '.versions[0].version')
          
          if [ "$LATEST_VER" == "null" ] || [ -z "$LATEST_VER" ]; then
            echo "Error: Could not retrieve a valid application version."
            exit 1
          fi
          
          echo "Found latest application version: $LATEST_VER"
          echo "app_ver=$LATEST_VER" >> $GITHUB_OUTPUT

      - name: Promote application to ${{ env.TARGET_STAGE }}
        id: promote_step
        run: |
          APP_VER=${{ steps.get_app_ver.outputs.app_ver }}
          REQUEST_BODY="{\"target_stage\":\"$TARGET_STAGE\"}"
          
          PROMOTION_URL="$JF_URL/apptrust/api/v1/applications/$APP_ID/versions/$APP_VER/promote"
          echo "Promoting version $APP_VER to stage $TARGET_STAGE..."
          
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -H "Authorization: Bearer $JF_ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$REQUEST_BODY" \
            "$PROMOTION_URL")
          
          echo "Promotion request returned status code: $STATUS_CODE"
          
          # The API returns 200, 201, or 202 on success, depending on the promotion process.
          if [[ "$STATUS_CODE" -ge 200 && "$STATUS_CODE" -le 202 ]]; then
            echo "Successfully promoted $APP_ID version $APP_VER to $TARGET_STAGE."
          else
            echo "Failed to promote application. HTTP status code: $STATUS_CODE"
            exit 1
          fi

      - name: Notify Kargo to Deploy
        run: |
          set +e
          if [ "${{ env.TARGET_STAGE }}" == "prod" -o "${{ env.TARGET_STAGE }}" == "PROD" ]; then
              echo "Env ${{ env.TARGET_STAGE }} is PRODD, notifying cargo."
              RELEASED_VERSION="{ \"app_id\": \"${{ env.TARGET_STAGE }}\", \"app_ver\": \"\${{ steps.get_app_ver.outputs.app_ver }}"}"
              mkdir -p kargo
              echo "$RELEASED_VERSION" > kargo/release_version
              echo "Created release version file:"
              cat kargo/release_version
              echo
              git config user.name "github-actions[bot]"
              git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
              if [ "" != "$(git diff)" ]; then
                  echo "Release version changed, pushing..."
                  git add kargo/release_version && git commit -m "Update kargo/release_version to $RELEASED_VERSION" && git push
              else
                  echo "Release version was not changed."
              fi
          else
              echo "Env ${{ env.TARGET_STAGE }} is not PROD, not notifying kargo."
          fi

