name: JFrog Artifactory Integration Test

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - '.github/workflows/jfrog-integration-test.yml'
      - 'quoteofday/.jfrog/**'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - auth
        - maven
        - docker
        - api

env:
  DOCKER_REGISTRY: ${{ vars.DOCKER_REGISTRY }}
  JF_URL: ${{ vars.JF_URL }}
  JF_USER: ${{ vars.JF_USER }}

jobs:
  test-jfrog-authentication:
    name: Test JFrog Authentication
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4
      with:
        version: latest
      env:
        JF_URL: ${{ vars.JF_URL }}
        JF_USER: ${{ vars.JF_USER }}
        JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

    - name: Test JFrog CLI Authentication
      run: |
        echo "ğŸ” Testing JFrog CLI Authentication..."
        jf c show
        echo "âœ… JFrog CLI configuration loaded"
        
    - name: Test JFrog Connection
      run: |
        echo "ğŸ” Testing connection to JFrog Artifactory..."
        jf rt ping
        echo "âœ… Successfully connected to JFrog Artifactory"

  test-maven-integration:
    name: Test Maven Integration
    runs-on: ubuntu-latest
    needs: test-jfrog-authentication
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'

    - name: Setup JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4
      with:
        version: latest
      env:
        JF_URL: ${{ vars.JF_URL }}
        JF_USER: ${{ vars.JF_USER }}
        JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

    - name: Test Maven Repository Access
      run: |
        echo "ğŸ“¦ Testing Maven repository access..."
        cd quoteofday
        
        # Test if we can access the repository
        jf rt search "commons-dev-maven-virtual/*" --limit 5
        echo "âœ… Maven repository access successful"

    - name: Test Maven Build with JFrog
      run: |
        echo "ğŸ”¨ Testing Maven build with JFrog integration..."
        cd quoteofday
        
        # Test Maven build with JFrog
        jf mvn clean compile -q --batch-mode --no-transfer-progress
        echo "âœ… Maven build with JFrog successful"

    - name: Test Maven Deploy
      run: |
        echo "ğŸ“¤ Testing Maven deploy to JFrog..."
        cd quoteofday
        
        # Test deploy (this will fail if auth is wrong, but we can see the error)
        jf mvn deploy -q --batch-mode --no-transfer-progress || echo "âš ï¸ Deploy test completed (may fail due to repository permissions)"

  test-docker-integration:
    name: Test Docker Integration
    runs-on: ubuntu-latest
    needs: test-jfrog-authentication
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4
      with:
        version: latest
      env:
        JF_URL: ${{ vars.JF_URL }}
        JF_USER: ${{ vars.JF_USER }}
        JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

    - name: Test Docker Registry Login
      run: |
        echo "ğŸ³ Testing Docker registry login..."
        echo ${{ secrets.JF_ACCESS_TOKEN }} | docker login -u ${{ vars.JF_USER }} --password-stdin ${{ vars.DOCKER_REGISTRY }}
        echo "âœ… Docker registry login successful"

    - name: Test Docker Build
      run: |
        echo "ğŸ”¨ Testing Docker build..."
        cd quoteofday
        docker build -t test-image .
        echo "âœ… Docker build successful"

    - name: Test Docker Push
      run: |
        echo "ğŸ“¤ Testing Docker push to JFrog..."
        cd quoteofday
        docker tag test-image ${{ vars.DOCKER_REGISTRY }}/test-image:integration-test
        docker push ${{ vars.DOCKER_REGISTRY }}/test-image:integration-test || echo "âš ï¸ Push test completed (may fail due to repository permissions)"
        echo "âœ… Docker push test completed"

  test-jfrog-api:
    name: Test JFrog API Access
    runs-on: ubuntu-latest
    needs: test-jfrog-authentication
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4
      with:
        version: latest
      env:
        JF_URL: ${{ vars.JF_URL }}
        JF_USER: ${{ vars.JF_USER }}
        JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

    - name: Test JFrog API Access
      run: |
        echo "ğŸŒ Testing JFrog API access..."
        
        # Test API access using JFrog CLI
        jf rt curl -XGET "/api/repositories" --server-id setup-jfrog-cli-server
        echo "âœ… JFrog API access successful"

    - name: Test Repository List
      run: |
        echo "ğŸ“‹ Testing repository listing..."
        jf rt curl -XGET "/api/repositories" --server-id setup-jfrog-cli-server
        echo "âœ… Repository listing successful"

  test-configuration-validation:
    name: Test Configuration Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate Environment Variables
      run: |
        echo "ğŸ” Validating environment variables..."
        echo "JF_URL: ${{ vars.JF_URL }}"
        echo "JF_USER: ${{ vars.JF_USER }}"
        echo "DOCKER_REGISTRY: ${{ vars.DOCKER_REGISTRY }}"
        
        if [ -z "${{ vars.JF_URL }}" ]; then
          echo "âŒ JF_URL is not set"
          exit 1
        fi
        
        if [ -z "${{ vars.JF_USER }}" ]; then
          echo "âŒ JF_USER is not set"
          exit 1
        fi
        
        if [ -z "${{ vars.DOCKER_REGISTRY }}" ]; then
          echo "âŒ DOCKER_REGISTRY is not set"
          exit 1
        fi
        
        echo "âœ… All environment variables are set"

    - name: Validate JFrog Configuration Files
      run: |
        echo "ğŸ“ Validating JFrog configuration files..."
        
        if [ ! -f "quoteofday/.jfrog/projects/maven.yaml" ]; then
          echo "âŒ Maven configuration file not found"
          exit 1
        fi
        
        echo "âœ… JFrog configuration files found"
        
        # Validate YAML syntax
        python3 -c "import yaml; yaml.safe_load(open('quoteofday/.jfrog/projects/maven.yaml'))"
        echo "âœ… Maven configuration YAML is valid"

  generate-integration-report:
    name: Generate Integration Report
    runs-on: ubuntu-latest
    needs: [test-jfrog-authentication, test-maven-integration, test-docker-integration, test-jfrog-api, test-configuration-validation]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Generate Test Report
      run: |
        echo "ğŸ“Š Generating JFrog Integration Test Report..."
        echo "================================================"
        echo "JFrog Artifactory Integration Test Report"
        echo "================================================"
        echo "Test Date: $(date)"
        echo "JFrog URL: ${{ vars.JF_URL }}"
        echo "Docker Registry: ${{ vars.DOCKER_REGISTRY }}"
        echo ""
        echo "Test Results:"
        echo "- Authentication: ${{ needs.test-jfrog-authentication.result }}"
        echo "- Maven Integration: ${{ needs.test-maven-integration.result }}"
        echo "- Docker Integration: ${{ needs.test-docker-integration.result }}"
        echo "- API Access: ${{ needs.test-jfrog-api.result }}"
        echo "- Configuration: ${{ needs.test-configuration-validation.result }}"
        echo ""
        echo "Overall Status: ${{ job.status }}"
        
        # Create a summary file
        cat > integration-test-summary.md << EOF
        # JFrog Artifactory Integration Test Summary
        
        ## Test Results
        - **Authentication**: ${{ needs.test-jfrog-authentication.result }}
        - **Maven Integration**: ${{ needs.test-maven-integration.result }}
        - **Docker Integration**: ${{ needs.test-docker-integration.result }}
        - **API Access**: ${{ needs.test-jfrog-api.result }}
        - **Configuration**: ${{ needs.test-configuration-validation.result }}
        
        ## Environment
        - JFrog URL: ${{ vars.JF_URL }}
        - Docker Registry: ${{ vars.DOCKER_REGISTRY }}
        - Test Date: $(date)
        
        ## Next Steps
        If any tests failed, check:
        1. Environment variables in GitHub repository settings
        2. JFrog Artifactory permissions
        3. Repository configurations
        4. Network connectivity
        EOF
        
        echo "âœ… Integration test report generated"

    - name: Upload Test Report
      uses: actions/upload-artifact@v4
      with:
        name: jfrog-integration-test-report
        path: integration-test-summary.md
        retention-days: 30
