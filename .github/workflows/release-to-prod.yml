name: Release to PROD

on:
  push:
    paths:
      - '.github/workflows/release-to-prod.yml'
  workflow_dispatch:

jobs:
  release-to-prod:
    name: Release Latest QA Release Bundle to PROD
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Setup JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4
      with:
        version: latest
      env:
        JF_URL: ${{ vars.JF_URL }}
        JF_USER: ${{ vars.JF_USER }}
        JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
    
    - name: Get latest QA release bundle version
      id: get-latest-qa-version
      run: |
        # Fetch promotion records from Artifactory API
        PROMOTION_RESPONSE=$(curl -s -X GET \
          -H "Authorization: Bearer ${{ secrets.JF_ACCESS_TOKEN }}" \
          "${{ vars.JF_URL }}/lifecycle/api/v2/promotion/records/quotopia")

        # Filter for environment "QA", sort by "created" field in descending order, and get the first one
        LATEST_QA_VERSION=$(echo "$PROMOTION_RESPONSE" | \
          jq -r '.promotions | map(select(.environment == "QA")) | sort_by(.created) | reverse | .[0].release_bundle_version')
        
        echo "latest_qa_version=$LATEST_QA_VERSION" >> $GITHUB_OUTPUT
        echo "Found latest QA release bundle version: $LATEST_QA_VERSION"
    
    - name: Release to Prod
      run: |
        LATEST_QA_VERSION="${{ steps.get-latest-qa-version.outputs.latest_qa_version }}"
        
        echo "üöÄ Promoting release bundle quotopia version $LATEST_QA_VERSION from QA to PROD..."
        
        # Promote the release bundle from QA to PROD
        jf release-bundle-promote quotopia $LATEST_QA_VERSION PROD
        
        if [ $? -eq 0 ]; then
          echo "‚úÖ Successfully released quotopia version $LATEST_QA_VERSION to PROD"
          
          # Create a link to the QA release bundle
          QA_LINK="${{ vars.JF_URL }}/ui/artifactory/lifecycle?bundleName=quotopia&releaseBundleVersion=$LATEST_QA_VERSION&repositoryKey=release-bundles-v2&activeVersionTab=Evidence%20Graph"
          echo "üöÄ Release [quotopia:$LATEST_QA_VERSION QA]($QA_LINK) to PROD" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå Failed to release quotopia version $LATEST_QA_VERSION to PROD"
          exit 1
        fi
